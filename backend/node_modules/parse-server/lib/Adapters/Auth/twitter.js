"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _Config = _interopRequireDefault(require("../../Config"));
var _querystring = _interopRequireDefault(require("querystring"));
var _AuthAdapter = _interopRequireDefault(require("./AuthAdapter"));
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
/**
 * Parse Server authentication adapter for Twitter.
 *
 * @class TwitterAdapter
 * @param {Object} options - The adapter configuration options.
 * @param {string} options.consumerKey - The Twitter App Consumer Key. Required for secure authentication.
 * @param {string} options.consumerSecret - The Twitter App Consumer Secret. Required for secure authentication.
 * @param {boolean} [options.enableInsecureAuth=false] - **[DEPRECATED]** Enable insecure authentication (not recommended).
 *
 * @description
 * ## Parse Server Configuration
 * To configure Parse Server for Twitter authentication, use the following structure:
 * ### Secure Configuration
 * ```json
 * {
 *   "auth": {
 *     "twitter": {
 *       "consumerKey": "your-consumer-key",
 *       "consumerSecret": "your-consumer-secret"
 *     }
 *   }
 * }
 * ```
 * ### Insecure Configuration (Not Recommended)
 * ```json
 * {
 *   "auth": {
 *     "twitter": {
 *       "enableInsecureAuth": true
 *     }
 *   }
 * }
 * ```
 *
 * The adapter requires the following `authData` fields:
 * - **Secure Authentication**: `oauth_token`, `oauth_verifier`.
 * - **Insecure Authentication (Not Recommended)**: `id`, `oauth_token`, `oauth_token_secret`.
 *
 * ## Auth Payloads
 * ### Secure Authentication Payload
 * ```json
 * {
 *   "twitter": {
 *     "oauth_token": "1234567890-abc123def456",
 *     "oauth_verifier": "abc123def456"
 *   }
 * }
 * ```
 *
 * ### Insecure Authentication Payload (Not Recommended)
 * ```json
 * {
 *   "twitter": {
 *     "id": "1234567890",
 *     "oauth_token": "1234567890-abc123def456",
 *     "oauth_token_secret": "1234567890-abc123def456"
 *   }
 * }
 * ```
 *
 * ## Notes
 * - **Deprecation Notice**: `enableInsecureAuth` and insecure fields (`id`, `oauth_token_secret`) are **deprecated** and may be removed in future versions. Use secure authentication with `consumerKey` and `consumerSecret`.
 * - Secure authentication exchanges the `oauth_token` and `oauth_verifier` provided by the client for an access token using Twitter's OAuth API.
 *
 * @see {@link https://developer.twitter.com/en/docs/authentication/oauth-1-0a Twitter OAuth Documentation}
 */

class TwitterAuthAdapter extends _AuthAdapter.default {
  validateOptions(options) {
    if (!options) {
      throw new Error('Twitter auth options are required.');
    }
    this.enableInsecureAuth = options.enableInsecureAuth;
    if (!this.enableInsecureAuth && (!options.consumer_key || !options.consumer_secret)) {
      throw new Error('Consumer key and secret are required for secure Twitter auth.');
    }
  }
  async validateAuthData(authData, options) {
    const config = _Config.default.get(Parse.applicationId);
    const twitterConfig = config.auth.twitter;
    if (this.enableInsecureAuth && twitterConfig && config.enableInsecureAuthAdapters) {
      return this.validateInsecureAuth(authData, options);
    }
    if (!options.consumer_key || !options.consumer_secret) {
      throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Twitter auth configuration missing consumer_key and/or consumer_secret.');
    }
    const accessTokenData = await this.exchangeAccessToken(authData);
    if (accessTokenData?.oauth_token && accessTokenData?.user_id) {
      authData.id = accessTokenData.user_id;
      authData.auth_token = accessTokenData.oauth_token;
      return;
    }
    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Twitter auth is invalid for this user.');
  }
  async validateInsecureAuth(authData, options) {
    if (!authData.oauth_token || !authData.oauth_token_secret) {
      throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Twitter insecure auth requires oauth_token and oauth_token_secret.');
    }
    options = this.handleMultipleConfigurations(authData, options);
    const data = await this.request(authData, options);
    const parsedData = await data.json();
    if (parsedData?.id === authData.id) {
      return;
    }
    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Twitter auth is invalid for this user.');
  }
  async exchangeAccessToken(authData) {
    const accessTokenRequestOptions = {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: _querystring.default.stringify({
        oauth_token: authData.oauth_token,
        oauth_verifier: authData.oauth_verifier
      })
    };
    const response = await fetch('https://api.twitter.com/oauth/access_token', accessTokenRequestOptions);
    if (!response.ok) {
      throw new Error('Failed to exchange access token.');
    }
    return response.json();
  }
  handleMultipleConfigurations(authData, options) {
    if (Array.isArray(options)) {
      const consumer_key = authData.consumer_key;
      if (!consumer_key) {
        throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Twitter auth is invalid for this user.');
      }
      options = options.filter(option => option.consumer_key === consumer_key);
      if (options.length === 0) {
        throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Twitter auth is invalid for this user.');
      }
      return options[0];
    }
    return options;
  }
  async request(authData, options) {
    const {
      consumer_key,
      consumer_secret
    } = options;
    const oauth = {
      consumer_key,
      consumer_secret,
      auth_token: authData.oauth_token,
      auth_token_secret: authData.oauth_token_secret
    };
    const url = new URL('https://api.twitter.com/2/users/me');
    const response = await fetch(url, {
      headers: {
        Authorization: 'Bearer ' + oauth.auth_token
      },
      body: JSON.stringify(oauth)
    });
    if (!response.ok) {
      throw new Error('Failed to fetch user data.');
    }
    return response;
  }
  async beforeFind(authData) {
    if (this.enableInsecureAuth && !authData?.code) {
      if (!authData?.access_token) {
        throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Twitter auth is invalid for this user.');
      }
      const user = await this.getUserFromAccessToken(authData.access_token, authData);
      if (user.id !== authData.id) {
        throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Twitter auth is invalid for this user.');
      }
      return;
    }
    if (!authData?.code) {
      throw new Parse.Error(Parse.Error.VALIDATION_ERROR, 'Twitter code is required.');
    }
    const access_token = await this.exchangeAccessToken(authData);
    const user = await this.getUserFromAccessToken(access_token, authData);
    authData.access_token = access_token;
    authData.id = user.id;
    delete authData.code;
    delete authData.redirect_uri;
  }
  validateAppId() {
    return Promise.resolve();
  }
}
var _default = exports.default = new TwitterAuthAdapter();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfQ29uZmlnIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfcXVlcnlzdHJpbmciLCJfQXV0aEFkYXB0ZXIiLCJlIiwiX19lc01vZHVsZSIsImRlZmF1bHQiLCJUd2l0dGVyQXV0aEFkYXB0ZXIiLCJBdXRoQWRhcHRlciIsInZhbGlkYXRlT3B0aW9ucyIsIm9wdGlvbnMiLCJFcnJvciIsImVuYWJsZUluc2VjdXJlQXV0aCIsImNvbnN1bWVyX2tleSIsImNvbnN1bWVyX3NlY3JldCIsInZhbGlkYXRlQXV0aERhdGEiLCJhdXRoRGF0YSIsImNvbmZpZyIsIkNvbmZpZyIsImdldCIsIlBhcnNlIiwiYXBwbGljYXRpb25JZCIsInR3aXR0ZXJDb25maWciLCJhdXRoIiwidHdpdHRlciIsImVuYWJsZUluc2VjdXJlQXV0aEFkYXB0ZXJzIiwidmFsaWRhdGVJbnNlY3VyZUF1dGgiLCJPQkpFQ1RfTk9UX0ZPVU5EIiwiYWNjZXNzVG9rZW5EYXRhIiwiZXhjaGFuZ2VBY2Nlc3NUb2tlbiIsIm9hdXRoX3Rva2VuIiwidXNlcl9pZCIsImlkIiwiYXV0aF90b2tlbiIsIm9hdXRoX3Rva2VuX3NlY3JldCIsImhhbmRsZU11bHRpcGxlQ29uZmlndXJhdGlvbnMiLCJkYXRhIiwicmVxdWVzdCIsInBhcnNlZERhdGEiLCJqc29uIiwiYWNjZXNzVG9rZW5SZXF1ZXN0T3B0aW9ucyIsIm1ldGhvZCIsImhlYWRlcnMiLCJib2R5IiwicXVlcnlzdHJpbmciLCJzdHJpbmdpZnkiLCJvYXV0aF92ZXJpZmllciIsInJlc3BvbnNlIiwiZmV0Y2giLCJvayIsIkFycmF5IiwiaXNBcnJheSIsImZpbHRlciIsIm9wdGlvbiIsImxlbmd0aCIsIm9hdXRoIiwiYXV0aF90b2tlbl9zZWNyZXQiLCJ1cmwiLCJVUkwiLCJBdXRob3JpemF0aW9uIiwiSlNPTiIsImJlZm9yZUZpbmQiLCJjb2RlIiwiYWNjZXNzX3Rva2VuIiwidXNlciIsImdldFVzZXJGcm9tQWNjZXNzVG9rZW4iLCJWQUxJREFUSU9OX0VSUk9SIiwicmVkaXJlY3RfdXJpIiwidmFsaWRhdGVBcHBJZCIsIlByb21pc2UiLCJyZXNvbHZlIiwiX2RlZmF1bHQiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL0FkYXB0ZXJzL0F1dGgvdHdpdHRlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFBhcnNlIFNlcnZlciBhdXRoZW50aWNhdGlvbiBhZGFwdGVyIGZvciBUd2l0dGVyLlxuICpcbiAqIEBjbGFzcyBUd2l0dGVyQWRhcHRlclxuICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBUaGUgYWRhcHRlciBjb25maWd1cmF0aW9uIG9wdGlvbnMuXG4gKiBAcGFyYW0ge3N0cmluZ30gb3B0aW9ucy5jb25zdW1lcktleSAtIFRoZSBUd2l0dGVyIEFwcCBDb25zdW1lciBLZXkuIFJlcXVpcmVkIGZvciBzZWN1cmUgYXV0aGVudGljYXRpb24uXG4gKiBAcGFyYW0ge3N0cmluZ30gb3B0aW9ucy5jb25zdW1lclNlY3JldCAtIFRoZSBUd2l0dGVyIEFwcCBDb25zdW1lciBTZWNyZXQuIFJlcXVpcmVkIGZvciBzZWN1cmUgYXV0aGVudGljYXRpb24uXG4gKiBAcGFyYW0ge2Jvb2xlYW59IFtvcHRpb25zLmVuYWJsZUluc2VjdXJlQXV0aD1mYWxzZV0gLSAqKltERVBSRUNBVEVEXSoqIEVuYWJsZSBpbnNlY3VyZSBhdXRoZW50aWNhdGlvbiAobm90IHJlY29tbWVuZGVkKS5cbiAqXG4gKiBAZGVzY3JpcHRpb25cbiAqICMjIFBhcnNlIFNlcnZlciBDb25maWd1cmF0aW9uXG4gKiBUbyBjb25maWd1cmUgUGFyc2UgU2VydmVyIGZvciBUd2l0dGVyIGF1dGhlbnRpY2F0aW9uLCB1c2UgdGhlIGZvbGxvd2luZyBzdHJ1Y3R1cmU6XG4gKiAjIyMgU2VjdXJlIENvbmZpZ3VyYXRpb25cbiAqIGBgYGpzb25cbiAqIHtcbiAqICAgXCJhdXRoXCI6IHtcbiAqICAgICBcInR3aXR0ZXJcIjoge1xuICogICAgICAgXCJjb25zdW1lcktleVwiOiBcInlvdXItY29uc3VtZXIta2V5XCIsXG4gKiAgICAgICBcImNvbnN1bWVyU2VjcmV0XCI6IFwieW91ci1jb25zdW1lci1zZWNyZXRcIlxuICogICAgIH1cbiAqICAgfVxuICogfVxuICogYGBgXG4gKiAjIyMgSW5zZWN1cmUgQ29uZmlndXJhdGlvbiAoTm90IFJlY29tbWVuZGVkKVxuICogYGBganNvblxuICoge1xuICogICBcImF1dGhcIjoge1xuICogICAgIFwidHdpdHRlclwiOiB7XG4gKiAgICAgICBcImVuYWJsZUluc2VjdXJlQXV0aFwiOiB0cnVlXG4gKiAgICAgfVxuICogICB9XG4gKiB9XG4gKiBgYGBcbiAqXG4gKiBUaGUgYWRhcHRlciByZXF1aXJlcyB0aGUgZm9sbG93aW5nIGBhdXRoRGF0YWAgZmllbGRzOlxuICogLSAqKlNlY3VyZSBBdXRoZW50aWNhdGlvbioqOiBgb2F1dGhfdG9rZW5gLCBgb2F1dGhfdmVyaWZpZXJgLlxuICogLSAqKkluc2VjdXJlIEF1dGhlbnRpY2F0aW9uIChOb3QgUmVjb21tZW5kZWQpKio6IGBpZGAsIGBvYXV0aF90b2tlbmAsIGBvYXV0aF90b2tlbl9zZWNyZXRgLlxuICpcbiAqICMjIEF1dGggUGF5bG9hZHNcbiAqICMjIyBTZWN1cmUgQXV0aGVudGljYXRpb24gUGF5bG9hZFxuICogYGBganNvblxuICoge1xuICogICBcInR3aXR0ZXJcIjoge1xuICogICAgIFwib2F1dGhfdG9rZW5cIjogXCIxMjM0NTY3ODkwLWFiYzEyM2RlZjQ1NlwiLFxuICogICAgIFwib2F1dGhfdmVyaWZpZXJcIjogXCJhYmMxMjNkZWY0NTZcIlxuICogICB9XG4gKiB9XG4gKiBgYGBcbiAqXG4gKiAjIyMgSW5zZWN1cmUgQXV0aGVudGljYXRpb24gUGF5bG9hZCAoTm90IFJlY29tbWVuZGVkKVxuICogYGBganNvblxuICoge1xuICogICBcInR3aXR0ZXJcIjoge1xuICogICAgIFwiaWRcIjogXCIxMjM0NTY3ODkwXCIsXG4gKiAgICAgXCJvYXV0aF90b2tlblwiOiBcIjEyMzQ1Njc4OTAtYWJjMTIzZGVmNDU2XCIsXG4gKiAgICAgXCJvYXV0aF90b2tlbl9zZWNyZXRcIjogXCIxMjM0NTY3ODkwLWFiYzEyM2RlZjQ1NlwiXG4gKiAgIH1cbiAqIH1cbiAqIGBgYFxuICpcbiAqICMjIE5vdGVzXG4gKiAtICoqRGVwcmVjYXRpb24gTm90aWNlKio6IGBlbmFibGVJbnNlY3VyZUF1dGhgIGFuZCBpbnNlY3VyZSBmaWVsZHMgKGBpZGAsIGBvYXV0aF90b2tlbl9zZWNyZXRgKSBhcmUgKipkZXByZWNhdGVkKiogYW5kIG1heSBiZSByZW1vdmVkIGluIGZ1dHVyZSB2ZXJzaW9ucy4gVXNlIHNlY3VyZSBhdXRoZW50aWNhdGlvbiB3aXRoIGBjb25zdW1lcktleWAgYW5kIGBjb25zdW1lclNlY3JldGAuXG4gKiAtIFNlY3VyZSBhdXRoZW50aWNhdGlvbiBleGNoYW5nZXMgdGhlIGBvYXV0aF90b2tlbmAgYW5kIGBvYXV0aF92ZXJpZmllcmAgcHJvdmlkZWQgYnkgdGhlIGNsaWVudCBmb3IgYW4gYWNjZXNzIHRva2VuIHVzaW5nIFR3aXR0ZXIncyBPQXV0aCBBUEkuXG4gKlxuICogQHNlZSB7QGxpbmsgaHR0cHM6Ly9kZXZlbG9wZXIudHdpdHRlci5jb20vZW4vZG9jcy9hdXRoZW50aWNhdGlvbi9vYXV0aC0xLTBhIFR3aXR0ZXIgT0F1dGggRG9jdW1lbnRhdGlvbn1cbiAqL1xuXG5pbXBvcnQgQ29uZmlnIGZyb20gJy4uLy4uL0NvbmZpZyc7XG5pbXBvcnQgcXVlcnlzdHJpbmcgZnJvbSAncXVlcnlzdHJpbmcnO1xuaW1wb3J0IEF1dGhBZGFwdGVyIGZyb20gJy4vQXV0aEFkYXB0ZXInO1xuXG5jbGFzcyBUd2l0dGVyQXV0aEFkYXB0ZXIgZXh0ZW5kcyBBdXRoQWRhcHRlciB7XG4gIHZhbGlkYXRlT3B0aW9ucyhvcHRpb25zKSB7XG4gICAgaWYgKCFvcHRpb25zKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1R3aXR0ZXIgYXV0aCBvcHRpb25zIGFyZSByZXF1aXJlZC4nKTtcbiAgICB9XG5cbiAgICB0aGlzLmVuYWJsZUluc2VjdXJlQXV0aCA9IG9wdGlvbnMuZW5hYmxlSW5zZWN1cmVBdXRoO1xuXG4gICAgaWYgKCF0aGlzLmVuYWJsZUluc2VjdXJlQXV0aCAmJiAoIW9wdGlvbnMuY29uc3VtZXJfa2V5IHx8ICFvcHRpb25zLmNvbnN1bWVyX3NlY3JldCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ29uc3VtZXIga2V5IGFuZCBzZWNyZXQgYXJlIHJlcXVpcmVkIGZvciBzZWN1cmUgVHdpdHRlciBhdXRoLicpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHZhbGlkYXRlQXV0aERhdGEoYXV0aERhdGEsIG9wdGlvbnMpIHtcbiAgICBjb25zdCBjb25maWcgPSBDb25maWcuZ2V0KFBhcnNlLmFwcGxpY2F0aW9uSWQpO1xuICAgIGNvbnN0IHR3aXR0ZXJDb25maWcgPSBjb25maWcuYXV0aC50d2l0dGVyO1xuXG4gICAgaWYgKHRoaXMuZW5hYmxlSW5zZWN1cmVBdXRoICYmIHR3aXR0ZXJDb25maWcgJiYgY29uZmlnLmVuYWJsZUluc2VjdXJlQXV0aEFkYXB0ZXJzKSB7XG4gICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZUluc2VjdXJlQXV0aChhdXRoRGF0YSwgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgaWYgKCFvcHRpb25zLmNvbnN1bWVyX2tleSB8fCAhb3B0aW9ucy5jb25zdW1lcl9zZWNyZXQpIHtcbiAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihcbiAgICAgICAgUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCxcbiAgICAgICAgJ1R3aXR0ZXIgYXV0aCBjb25maWd1cmF0aW9uIG1pc3NpbmcgY29uc3VtZXJfa2V5IGFuZC9vciBjb25zdW1lcl9zZWNyZXQuJ1xuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBhY2Nlc3NUb2tlbkRhdGEgPSBhd2FpdCB0aGlzLmV4Y2hhbmdlQWNjZXNzVG9rZW4oYXV0aERhdGEpO1xuXG4gICAgaWYgKGFjY2Vzc1Rva2VuRGF0YT8ub2F1dGhfdG9rZW4gJiYgYWNjZXNzVG9rZW5EYXRhPy51c2VyX2lkKSB7XG4gICAgICBhdXRoRGF0YS5pZCA9IGFjY2Vzc1Rva2VuRGF0YS51c2VyX2lkO1xuICAgICAgYXV0aERhdGEuYXV0aF90b2tlbiA9IGFjY2Vzc1Rva2VuRGF0YS5vYXV0aF90b2tlbjtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICBQYXJzZS5FcnJvci5PQkpFQ1RfTk9UX0ZPVU5ELFxuICAgICAgJ1R3aXR0ZXIgYXV0aCBpcyBpbnZhbGlkIGZvciB0aGlzIHVzZXIuJ1xuICAgICk7XG4gIH1cblxuICBhc3luYyB2YWxpZGF0ZUluc2VjdXJlQXV0aChhdXRoRGF0YSwgb3B0aW9ucykge1xuICAgIGlmICghYXV0aERhdGEub2F1dGhfdG9rZW4gfHwgIWF1dGhEYXRhLm9hdXRoX3Rva2VuX3NlY3JldCkge1xuICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgICBQYXJzZS5FcnJvci5PQkpFQ1RfTk9UX0ZPVU5ELFxuICAgICAgICAnVHdpdHRlciBpbnNlY3VyZSBhdXRoIHJlcXVpcmVzIG9hdXRoX3Rva2VuIGFuZCBvYXV0aF90b2tlbl9zZWNyZXQuJ1xuICAgICAgKTtcbiAgICB9XG5cbiAgICBvcHRpb25zID0gdGhpcy5oYW5kbGVNdWx0aXBsZUNvbmZpZ3VyYXRpb25zKGF1dGhEYXRhLCBvcHRpb25zKTtcblxuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLnJlcXVlc3QoYXV0aERhdGEsIG9wdGlvbnMpO1xuICAgIGNvbnN0IHBhcnNlZERhdGEgPSBhd2FpdCBkYXRhLmpzb24oKTtcblxuICAgIGlmIChwYXJzZWREYXRhPy5pZCA9PT0gYXV0aERhdGEuaWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICBQYXJzZS5FcnJvci5PQkpFQ1RfTk9UX0ZPVU5ELFxuICAgICAgJ1R3aXR0ZXIgYXV0aCBpcyBpbnZhbGlkIGZvciB0aGlzIHVzZXIuJ1xuICAgICk7XG4gIH1cblxuICBhc3luYyBleGNoYW5nZUFjY2Vzc1Rva2VuKGF1dGhEYXRhKSB7XG4gICAgY29uc3QgYWNjZXNzVG9rZW5SZXF1ZXN0T3B0aW9ucyA9IHtcbiAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcsXG4gICAgICB9LFxuICAgICAgYm9keTogcXVlcnlzdHJpbmcuc3RyaW5naWZ5KHtcbiAgICAgICAgb2F1dGhfdG9rZW46IGF1dGhEYXRhLm9hdXRoX3Rva2VuLFxuICAgICAgICBvYXV0aF92ZXJpZmllcjogYXV0aERhdGEub2F1dGhfdmVyaWZpZXIsXG4gICAgICB9KSxcbiAgICB9O1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCgnaHR0cHM6Ly9hcGkudHdpdHRlci5jb20vb2F1dGgvYWNjZXNzX3Rva2VuJywgYWNjZXNzVG9rZW5SZXF1ZXN0T3B0aW9ucyk7XG4gICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gZXhjaGFuZ2UgYWNjZXNzIHRva2VuLicpO1xuICAgIH1cblxuICAgIHJldHVybiByZXNwb25zZS5qc29uKCk7XG4gIH1cblxuICBoYW5kbGVNdWx0aXBsZUNvbmZpZ3VyYXRpb25zKGF1dGhEYXRhLCBvcHRpb25zKSB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkob3B0aW9ucykpIHtcbiAgICAgIGNvbnN0IGNvbnN1bWVyX2tleSA9IGF1dGhEYXRhLmNvbnN1bWVyX2tleTtcblxuICAgICAgaWYgKCFjb25zdW1lcl9rZXkpIHtcbiAgICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgICAgIFBhcnNlLkVycm9yLk9CSkVDVF9OT1RfRk9VTkQsXG4gICAgICAgICAgJ1R3aXR0ZXIgYXV0aCBpcyBpbnZhbGlkIGZvciB0aGlzIHVzZXIuJ1xuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBvcHRpb25zID0gb3B0aW9ucy5maWx0ZXIob3B0aW9uID0+IG9wdGlvbi5jb25zdW1lcl9rZXkgPT09IGNvbnN1bWVyX2tleSk7XG5cbiAgICAgIGlmIChvcHRpb25zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICAgICAgUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCxcbiAgICAgICAgICAnVHdpdHRlciBhdXRoIGlzIGludmFsaWQgZm9yIHRoaXMgdXNlci4nXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBvcHRpb25zWzBdO1xuICAgIH1cblxuICAgIHJldHVybiBvcHRpb25zO1xuICB9XG5cbiAgYXN5bmMgcmVxdWVzdChhdXRoRGF0YSwgb3B0aW9ucykge1xuICAgIGNvbnN0IHsgY29uc3VtZXJfa2V5LCBjb25zdW1lcl9zZWNyZXQgfSA9IG9wdGlvbnM7XG5cbiAgICBjb25zdCBvYXV0aCA9IHtcbiAgICAgIGNvbnN1bWVyX2tleSxcbiAgICAgIGNvbnN1bWVyX3NlY3JldCxcbiAgICAgIGF1dGhfdG9rZW46IGF1dGhEYXRhLm9hdXRoX3Rva2VuLFxuICAgICAgYXV0aF90b2tlbl9zZWNyZXQ6IGF1dGhEYXRhLm9hdXRoX3Rva2VuX3NlY3JldCxcbiAgICB9O1xuXG4gICAgY29uc3QgdXJsID0gbmV3IFVSTCgnaHR0cHM6Ly9hcGkudHdpdHRlci5jb20vMi91c2Vycy9tZScpO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHtcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgQXV0aG9yaXphdGlvbjogJ0JlYXJlciAnICsgb2F1dGguYXV0aF90b2tlbixcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShvYXV0aCksXG4gICAgfSk7XG5cbiAgICBpZiAoIXJlc3BvbnNlLm9rKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBmZXRjaCB1c2VyIGRhdGEuJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3BvbnNlO1xuICB9XG5cbiAgYXN5bmMgYmVmb3JlRmluZChhdXRoRGF0YSkge1xuICAgIGlmICh0aGlzLmVuYWJsZUluc2VjdXJlQXV0aCAmJiAhYXV0aERhdGE/LmNvZGUpIHtcbiAgICAgIGlmICghYXV0aERhdGE/LmFjY2Vzc190b2tlbikge1xuICAgICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCwgJ1R3aXR0ZXIgYXV0aCBpcyBpbnZhbGlkIGZvciB0aGlzIHVzZXIuJyk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLmdldFVzZXJGcm9tQWNjZXNzVG9rZW4oYXV0aERhdGEuYWNjZXNzX3Rva2VuLCBhdXRoRGF0YSk7XG5cbiAgICAgIGlmICh1c2VyLmlkICE9PSBhdXRoRGF0YS5pZCkge1xuICAgICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCwgJ1R3aXR0ZXIgYXV0aCBpcyBpbnZhbGlkIGZvciB0aGlzIHVzZXIuJyk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoIWF1dGhEYXRhPy5jb2RlKSB7XG4gICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuVkFMSURBVElPTl9FUlJPUiwgJ1R3aXR0ZXIgY29kZSBpcyByZXF1aXJlZC4nKTtcbiAgICB9XG5cbiAgICBjb25zdCBhY2Nlc3NfdG9rZW4gPSBhd2FpdCB0aGlzLmV4Y2hhbmdlQWNjZXNzVG9rZW4oYXV0aERhdGEpO1xuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLmdldFVzZXJGcm9tQWNjZXNzVG9rZW4oYWNjZXNzX3Rva2VuLCBhdXRoRGF0YSk7XG5cblxuICAgIGF1dGhEYXRhLmFjY2Vzc190b2tlbiA9IGFjY2Vzc190b2tlbjtcbiAgICBhdXRoRGF0YS5pZCA9IHVzZXIuaWQ7XG5cbiAgICBkZWxldGUgYXV0aERhdGEuY29kZTtcbiAgICBkZWxldGUgYXV0aERhdGEucmVkaXJlY3RfdXJpO1xuICB9XG5cbiAgdmFsaWRhdGVBcHBJZCgpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgbmV3IFR3aXR0ZXJBdXRoQWRhcHRlcigpO1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFtRUEsSUFBQUEsT0FBQSxHQUFBQyxzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUMsWUFBQSxHQUFBRixzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUUsWUFBQSxHQUFBSCxzQkFBQSxDQUFBQyxPQUFBO0FBQXdDLFNBQUFELHVCQUFBSSxDQUFBLFdBQUFBLENBQUEsSUFBQUEsQ0FBQSxDQUFBQyxVQUFBLEdBQUFELENBQUEsS0FBQUUsT0FBQSxFQUFBRixDQUFBO0FBckV4QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBTUEsTUFBTUcsa0JBQWtCLFNBQVNDLG9CQUFXLENBQUM7RUFDM0NDLGVBQWVBLENBQUNDLE9BQU8sRUFBRTtJQUN2QixJQUFJLENBQUNBLE9BQU8sRUFB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